<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./styles/styles.css">
</head>
<body>
    <h1>TIENDA DE DISCOS</h1>

    <div id="GaleriaDiscos">

    </div>

    <script>
        const galeria = document.getElementById("GaleriaDiscos");
        let listaDiscosRecuperada=[];

        // const ListaDiscos = fetch("http://localhost:4000/api/productos", {
        //     method: "GET",
        //     credentials: 'include',
        //     headers: { 'Accept': 'application/json' }
        // }).then((resp) => {
        //     return resp.json();
        // })

        // console.log(ListaDiscos);
        // const arrayDiscos = ListaDiscos.value;
        // console.log(arrayDiscos);


        fetch('http://localhost:4000/api/productos', {
            credentials: 'include',
            headers: { Accept: 'application/json' },
        })
            .then(resp => {
                if (!resp.ok) return resp.text().then(t => { throw new Error(`HTTP ${resp.status}: ${t}`); });
                return resp.json();
        })
            .then(discos => {
            console.log(discos);
            listaDiscosRecuperada=discos;
            for (let i = 0; i < discos.length; i++) {
                
                const div = document.createElement("div");
                div.className = "disco";
                div.innerHTML = `
                <h3>${discos[i].nombre}</h3>
                <p>AÃ±o de lanzamiento: ${discos[i].anio}</p>
                <p>Precio: ${discos[i].precio}â‚¬</p>
                <p>Stock: ${discos[i].stock}</p>
                <button data-id="${discos[i]._id}" class="btn-comprar">ComprarðŸ›’</button>
                `;
                
                galeria.appendChild(div);

                
            }
        })
            .catch(console.error);

        document.addEventListener("click", (event) => {
                if (event.target.matches(".btn-comprar")) {
                    const boton = event.target;
                    const idProducto = boton.dataset.id;
                    const discoComprado = listaDiscosRecuperada.find(disco => disco._id === idProducto);
                    const nombreDisco = discoComprado.nombre;
                    const precioDisco = discoComprado.precio;
                    const fecha = new Date();
                    const horaCompra = `${fecha.getFullYear()}/${fecha.getMonth() + 1}/${fecha.getDate()}/${fecha.getHours()}/${fecha.getMinutes()}/${fecha.getSeconds()}`;

                    console.log(nombreDisco);

                     fetch('http://localhost:4000/api/compras', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            nombre: nombreDisco,
                            total: precioDisco,
                            fecha: horaCompra,
                        })
                    })
                        .then(resp => {
                            if (!resp.ok) return resp.text().then(t => { throw new Error(`HTTP ${resp.status}: ${t}`); });
                            return resp.json();
                    })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                        alert(`Haz comprado el disco ${nombreDisco}!, el total de la compra es ${precioDisco}â‚¬, gracias por tu compra`)                    
                }

                    
                }
            );

    </script>
</body>
</html>